<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta http-equiv="Cache-Control" content="no-store, max-age=0, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title id="docTitle">看看ID QAQ</title>
<style>
  :root { --bg:#0a0e17; --fg:#fff; --muted:#a0aec0; --brand:#4361ee; --glass:rgba(255,255,255,.08); --line:rgba(255,255,255,.15); }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    min-height:100vh;color:var(--fg);
    background:var(--bg) url("/wallpaper有耳朵抖动.jpg") center/cover fixed no-repeat;
    -webkit-text-size-adjust:100%;
  }
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);pointer-events:none}
  .container{max-width:1100px;margin:0 auto;padding:20px}
  .page-title{color:#fff;font-size:28px;font-weight:700;text-align:center;margin:8px 0 12px}
  .subtitle{color:#fff;text-align:center;margin-bottom:12px}
  .name-chip{
    display:inline-block;padding:6px 12px;border:1px solid var(--line);border-radius:999px;
    background:rgba(67,97,238,.18); color:#fff;
  }
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:10px 0 18px}
  .picker{
    appearance:none;-webkit-appearance:none;
    padding:10px 14px;border-radius:999px;border:1px solid var(--line);
    background:var(--glass); color:#e9efff;font-size:14px;min-width:180px;
    box-shadow:0 6px 18px rgba(0,0,0,.35);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  }
  .picker:focus{outline:none;border-color:rgba(67,97,238,.55)}
  .content-wrapper{display:flex;flex-direction:column;gap:16px}

  /* 单设备 */
  #singleSection{display:block}
  .online-status{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(67,97,238,.18)}
  .online-status.offline{background:rgba(198,40,40,.22);border-color:rgba(255,158,158,.35)}
  .status-dot{width:10px;height:10px;border-radius:50%;background:#4caf50;animation:pulse 2s infinite}
  .offline .status-dot{background:#f44336}
  @keyframes pulse{0%{opacity:.7}50%{opacity:1}100%{opacity:.7}}
  .status-card{
    background:var(--glass);border:1px solid var(--line);border-radius:16px;padding:22px 18px;
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    box-shadow:0 12px 32px rgba(0,0,0,.35)
  }
  .status-title{color:#c9d3e7;font-size:14px;letter-spacing:.5px;text-transform:uppercase;margin-bottom:10px}
  .app-name{margin:10px 0 8px;font-size:24px;font-weight:700;line-height:1.3;padding:14px 12px;border-radius:12px;border:1px solid rgba(67,97,238,.3);background:rgba(67,97,238,.15);min-height:64px;display:flex;align-items:center;justify-content:center;text-align:center;word-break:break-word}
  .app-name.changed{animation:hl .7s ease}
  @keyframes hl{50%{transform:scale(1.02);color:#bfcafe}}
  .last-updated{color:#d6deee;font-size:13px;margin-top:6px}
  .muted{color:var(--muted);font-size:13px;margin-top:8px}

  /* 多设备：自适应网格 */
  #devicesWrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
  .card{
    background:var(--glass);border:1px solid var(--line);border-radius:16px;padding:16px;
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    box-shadow:0 10px 28px rgba(0,0,0,.32)
  }
  .card .name{font-size:13px;color:#cbd5e0;margin:4px 0 10px}
  .card .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;background:rgba(67,97,238,.18);border:1px solid var(--line);margin-bottom:10px}
  .card .badge.offline{background:rgba(198,40,40,.22);border-color:rgba(255,158,158,.35)}
  .card .dot{width:9px;height:9px;border-radius:50%;background:#4caf50}
  .card .badge.offline .dot{background:#f44336}
  .card .app{margin:8px 0 6px;font-size:18px;font-weight:700;line-height:1.35;padding:10px;border-radius:10px;border:1px solid rgba(67,97,238,.3);background:rgba(67,97,238,.12);min-height:54px;display:flex;align-items:center;justify-content:center;text-align:center}
  .card .clock{color:#cfe0ff;font-size:12px}
  .hide{display:none!important}

  /* iOS/Safari 降级 */
  @supports not ((-webkit-backdrop-filter: blur(0)) or (backdrop-filter: blur(0))) {
    .status-card, .card, .picker { background: rgba(255,255,255,.14); }
  }

  /* 小屏 & 横屏窄宽：一行一个设备 */
  @media (max-width: 480px),
         (max-width: 820px) and (orientation: landscape) {
    #devicesWrap { grid-template-columns: 1fr; gap: 12px; }
    .card { padding: 12px; }
  }

  @media (max-width:480px){ .app-name{font-size:18px;min-height:56px} }

  /* 顶部错误条 */
  #errbar{position:fixed;left:0;right:0;top:0;z-index:9999;display:none;background:#ff3b30;color:#fff;padding:10px 14px;font-size:14px}
</style>
</head>
<body>
<div id="errbar"></div>
<div class="overlay"></div>
<div class="container">
  <h1 id="pageTitle" class="page-title">看看ID QAQ</h1>
  <p class="subtitle">你可以通过这个网页来视奸 <span class="name-chip"><span id="nameChip">澜轶</span></span></p>

  <!-- 人名切换（分组切换） -->
  <div class="toolbar">
    <label for="nameSelect" style="align-self:center;color:#d9dff5">查看对象：</label>
    <select id="nameSelect" class="picker"></select>
  </div>

  <div class="content-wrapper">
    <!-- 单设备 -->
    <section id="singleSection">
      <div class="online-status" id="connectionStatus">
        <span class="status-dot"></span>
        <span id="statusText">在线</span>
      </div>
      <div class="status-card" style="margin-top:12px">
        <div class="status-title">当前正在使用</div>
        <div class="app-name" id="currentApp">等待更新中...</div>
        <div class="last-updated">最后更新时间：<span id="updateTime">--:--:--</span></div>
        <div class="muted" id="netHint" style="display:none"></div>
      </div>
    </section>

    <!-- 多设备 -->
    <section id="multiSection" class="hide">
      <div id="devicesWrap"></div>
      <div class="muted" id="netHintMulti" style="display:none"></div>
    </section>
  </div>
</div>
<script>
(function () {
  const DEFAULT_NAME = '澜轶'
  const DEFAULT_MACHINE = 'lanyi-desktop'
  const UPDATE_INTERVAL = 7000

  const qs = (sel) => document.querySelector(sel)
  const byId = (id) => document.getElementById(id)

  // —— URL 参数 —— //
  function getParams() {
    const p = new URLSearchParams(location.search)
    return {
      name: (p.get('name') || '').trim(),
      machine: (p.get('machine') || '').trim(),
      ttl: Math.max(15000, parseInt(p.get('ttl') || '15000', 10)),
      view: (p.get('view') || '').toLowerCase(), // 'group' 或空
    }
  }
  function setTitles(label) {
    const t = `看看${label} QAQ`
    document.title = t
    const h1 = qs('.page-title')
    if (h1) h1.textContent = t
    const chip = document.querySelector('.name-chip .dn')
    if (chip) chip.textContent = label
  }
  function timeAgoCN(iso) {
    const s = Math.max(0, Math.floor((Date.now() - new Date(iso).getTime()) / 1000))
    if (s < 60) return `${s} 秒前`
    const m = Math.floor(s / 60)
    if (m < 60) return `${m} 分钟前`
    const h = Math.floor(m / 60)
    return `${h} 小时前`
  }
  const pad2 = (n) => String(n).padStart(2, '0')
  const toHHMMSS = (d) => `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`

  async function safeFetchJSON(url) {
    try {
      const u = new URL(url, location.origin)
      u.searchParams.set('_t', Date.now().toString())
      const resp = await fetch(u.toString(), { cache: 'no-store' })
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`)
      return await resp.json()
    } catch {
      return null
    }
  }
  async function loadGroupMap() {
    const data = await safeFetchJSON('/api/group-map')
    return (data && typeof data === 'object') ? data : {}
  }
  async function fetchOneLatest(machine) {
    const u = new URL('/api/current-status', location.origin)
    u.searchParams.set('machine', machine)
    u.searchParams.set('limit', '1')
    u.searchParams.set('_t', Date.now().toString())
    const list = await safeFetchJSON(u.toString())
    return Array.isArray(list) && list[0] ? list[0] : null
  }

  // —— DOM —— //
  const singleSection = byId('singleSection')
  const multiSection  = byId('multiSection')
  const grid          = byId('devicesWrap')
  const selectEl      = byId('nameSelect')

  const single = {
    app: byId('currentApp'),
    statusWrap: byId('connectionStatus'),
    statusText: byId('statusText'),
    time: byId('updateTime'),
  }

  // —— 运行时状态 —— //
  let ttlMs = 15000
  let curName = ''
  let curMachines = []
  let gen = 0
  let timer = null
  const cardByMachine = new Map()
  const lastItemByMachine = new Map()

  // —— UI 工具 —— //
  function clearGrid() {
    if (grid) grid.innerHTML = ''
    cardByMachine.clear()
    lastItemByMachine.clear()
  }
  function ensureCard(machine) {
    let card = cardByMachine.get(machine)
    if (card) return card
    card = document.createElement('div')
    card.className = 'card'
    card.dataset.machine = machine
    card.innerHTML = `
      <div class="badge"><span class="dot"></span><span class="status-word">在线</span></div>
      <div class="name">${machine}</div>
      <div class="app">加载中...</div>
      <div class="clock">--:--:--</div>
    `
    grid.appendChild(card)
    cardByMachine.set(machine, card)
    return card
  }

  // —— 渲染 —— //
  function renderSingle(item, labelText) {
    if (!single.app || !single.statusWrap || !single.statusText || !single.time) return
    if (!item) {
      single.app.textContent = '未检测到应用'
      single.statusWrap.classList.add('offline')
      single.statusText.textContent = `${labelText}死了X-X`
      single.time.textContent = toHHMMSS(new Date())
      return
    }
    const last = Date.parse(item.access_time)
    const online = (Date.now() - last) <= ttlMs
    const app = item.window_title || item.app || '未知应用'
    single.app.textContent = online ? app : `掉线前使用：${app}`
    single.statusWrap.classList.toggle('offline', !online)
    single.statusText.textContent = online
      ? `${labelText}还活着QAQ`
      : `${labelText}死了X-X（最后在线：${timeAgoCN(item.access_time)}）`
    single.time.textContent = toHHMMSS(new Date(item.access_time))
  }
  function updateCard(machine, item) {
    const card = ensureCard(machine)
    const badge = card.querySelector('.badge')
    const statusWord = card.querySelector('.status-word')
    const appEl = card.querySelector('.app')
    const clock = card.querySelector('.clock')

    let show = item || lastItemByMachine.get(machine) || null
    if (!show) {
      badge.classList.add('offline')
      statusWord.textContent = '离线 · 无记录'
      appEl.textContent = '暂无记录'
      clock.textContent = '--:--:--'
      return
    }
    lastItemByMachine.set(machine, show)

    const last = Date.parse(show.access_time)
    const online = (Date.now() - last) <= ttlMs
    const app = show.window_title || show.app || '未知应用'

    badge.classList.toggle('offline', !online)
    statusWord.textContent = online ? '在线' : `离线 · ${timeAgoCN(show.access_time)}`
    appEl.textContent = online ? app : `掉线前使用：${app}`
    clock.textContent = toHHMMSS(new Date(show.access_time))
  }

  // —— 轮询 —— //
  async function pollGroup(thisGen) {
    await Promise.all(curMachines.map(async (m) => {
      const item = await fetchOneLatest(m)
      if (thisGen !== gen) return
      updateCard(m, item)
    }))
  }
  async function pollSingle(thisGen, machine, labelText) {
    const item = await fetchOneLatest(machine)
    if (thisGen !== gen) return
    renderSingle(item, labelText)
  }
  function startLoop(isGroupView, labelText) {
    if (timer) clearInterval(timer)
    const thisGen = gen
    const run = () => {
      if (isGroupView) pollGroup(thisGen)
      else {
        const machine = curMachines[0] || DEFAULT_MACHINE
        pollSingle(thisGen, machine, labelText)
      }
    }
    run()
    timer = setInterval(run, UPDATE_INTERVAL)
  }

  // —— 切换人名（来自下拉框） —— //
  function switchToName(name, groupMap) {
    // 更新 URL：保留 ttl/view，设置 name，去掉 machine
    const p = getParams()
    const u = new URL(location.href)
    u.searchParams.set('name', name)
    u.searchParams.delete('machine')
    if (p.view) u.searchParams.set('view', p.view)
    if (p.ttl) u.searchParams.set('ttl', String(p.ttl))
    history.replaceState(null, '', u.toString())

    // 重置状态并决定视图
    gen++
    ttlMs = p.ttl
    curName = name
    setTitles(name)

    const list = Array.isArray(groupMap[name]) ? groupMap[name] : []
    const isGroupView = (p.view === 'group') || (list.length > 1)

    if (isGroupView) {
      singleSection.classList.add('hide')
      multiSection.classList.remove('hide')
      clearGrid()
      curMachines = list.length ? list.slice() : [DEFAULT_MACHINE]
      curMachines.forEach(ensureCard)
      const st = byId('statusText')
      if (st) st.textContent = '还活着QAQ'
    } else {
      multiSection.classList.add('hide')
      singleSection.classList.remove('hide')
      clearGrid()
      const machine = list[0] || p.machine || DEFAULT_MACHINE
      curMachines = [machine]
    }
    startLoop(isGroupView, name)
  }

  // —— 下拉框填充 —— //
  function populateSelect(names, selected) {
    if (!selectEl) return
    selectEl.innerHTML = ''
    names.forEach(n => {
      const opt = new Option(n, n, false, n === selected)
      selectEl.add(opt)
    })
    selectEl.value = selected
  }

  // —— 主入口 —— //
  async function init() {
    const p = getParams()
    ttlMs = p.ttl

    const groupMap = await loadGroupMap()
    let names = Object.keys(groupMap)
    // 保证默认名存在于下拉框
    if (!names.includes(DEFAULT_NAME)) names.unshift(DEFAULT_NAME)
    // 初始选中
    const initName = (p.name || DEFAULT_NAME)
    populateSelect(names, initName)

    // 挂载切换事件：只在切换不同人名时清空并重建
    if (selectEl) {
      selectEl.onchange = () => {
        const newName = selectEl.value
        if (newName && newName !== curName) {
          switchToName(newName, groupMap)
        }
      }
    }

    // 首次进入
    switchToName(initName, groupMap)
  }

  document.addEventListener('DOMContentLoaded', init)
})()
</script>

</body>
</html>
